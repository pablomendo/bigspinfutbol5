<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Big Spin - Reserva de Canchas</title>
    <!-- Carga de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configuración de Google Font: Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --color-primary: #fcd34d; /* Amarillo de Big Spin */
            --color-dark: #1f2937; /* Gris oscuro / fondo */
            --color-text-light: #e5e7eb; /* Gris claro para texto */
            --color-available: #10b981; /* Verde esmeralda para disponible */
            --color-reserved: #dc2626; /* Rojo para reservado */
            --color-closed: #4b5563; /* Gris para cerrado */
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--color-dark);
            color: var(--color-text-light);
            min-height: 100vh;
        }
        .text-primary { color: var(--color-primary); }
        .bg-primary { background-color: var(--color-primary); }
        .border-primary { border-color: var(--color-primary); }
        .hour-slot {
            transition: all 0.2s ease-in-out;
            cursor: pointer;
        }
        .hour-slot:hover:not(.reserved):not(.closed) {
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(252, 211, 77, 0.3);
        }
        .available {
            background-color: rgba(16, 185, 129, 0.1);
            border: 1px solid var(--color-available);
            color: var(--color-available);
        }
        .reserved {
            background-color: rgba(220, 38, 38, 0.1);
            border: 1px solid var(--color-reserved);
            color: var(--color-reserved);
            cursor: not-allowed;
        }
        .closed {
            background-color: rgba(75, 85, 99, 0.2);
            border: 1px solid var(--color-closed);
            color: var(--color-closed);
            cursor: not-allowed;
            text-decoration: line-through;
        }
        .selected-slot {
            background-color: var(--color-primary) !important;
            color: #111827 !important;
            font-weight: 700;
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <!-- Header Section -->
    <header class="mb-8 p-4 bg-gray-800 shadow-xl rounded-xl flex flex-col md:flex-row justify-between items-center">
        <div class="flex items-center space-x-4">
            <!-- Logo Big Spin - RUTA ACTUALIZADA -->
            <img src="assets/logo.png" alt="Logo Big Spin" class="h-10">
            <h1 class="text-3xl font-bold text-white tracking-wider">BIG <span class="text-primary">SPIN</span></h1>
        </div>
        <p class="text-gray-400 mt-2 md:mt-0">Reserva de Canchas de Fútbol (10:00h - 24:00h Lun-Sáb)</p>
    </header>

    <!-- Main Content: Calendar and Sidebar -->
    <main class="grid grid-cols-1 lg:grid-cols-4 gap-8">

        <!-- Calendar Area (3/4 width on desktop) -->
        <section class="lg:col-span-3">
            <h2 class="text-2xl font-semibold mb-4 text-primary">Calendario de Turnos</h2>

            <!-- Court Selection Tabs -->
            <div id="court-selector" class="flex space-x-4 mb-6 p-2 bg-gray-800 rounded-xl shadow-inner">
                <button data-court="indoor" class="flex-1 py-2 px-4 rounded-lg font-medium transition-colors bg-primary text-gray-900 shadow-lg" onclick="selectCourt('indoor')">
                    Cancha Techada
                </button>
                <button data-court="outdoor" class="flex-1 py-2 px-4 rounded-lg font-medium transition-colors text-gray-300 hover:bg-gray-700" onclick="selectCourt('outdoor')">
                    Cancha al Aire Libre
                </button>
            </div>

            <!-- Calendar Display -->
            <div id="calendar-container" class="space-y-6">
                <!-- Days will be generated here -->
            </div>
        </section>

        <!-- Sidebar/Reservation Form (1/4 width on desktop) -->
        <aside class="lg:col-span-1 sticky top-8 h-fit">
            <div class="p-6 bg-gray-800 rounded-xl shadow-2xl">
                <h2 class="text-xl font-semibold mb-4 text-primary">Tu Reserva</h2>

                <div id="selected-reservation" class="mb-4 p-3 bg-gray-900 rounded-lg hidden">
                    <p class="text-gray-400 text-sm">Cancha:</p>
                    <p id="reserve-court" class="text-lg font-bold mb-1"></p>
                    <p class="text-gray-400 text-sm">Fecha y Hora:</p>
                    <p id="reserve-datetime" class="text-lg font-bold text-primary"></p>
                </div>

                <div id="no-selection-message" class="mb-4 p-3 bg-gray-900 rounded-lg text-center text-gray-400">
                    Selecciona un turno disponible en el calendario.
                </div>

                <!-- Reservation Form -->
                <form id="reservation-form" class="mt-4 hidden">
                    <div class="mb-4">
                        <label for="name" class="block text-sm font-medium text-gray-300 mb-1">Tu Nombre:</label>
                        <input type="text" id="name" required class="w-full p-2 rounded-lg bg-gray-700 border border-gray-600 focus:border-primary focus:ring-primary text-white" placeholder="Ej: Juan Pérez">
                    </div>
                    <div class="mb-6">
                        <label for="phone" class="block text-sm font-medium text-gray-300 mb-1">Teléfono (con código de área):</label>
                        <input type="tel" id="phone" required class="w-full p-2 rounded-lg bg-gray-700 border border-gray-600 focus:border-primary focus:ring-primary text-white" placeholder="Ej: 5491123456789">
                        <p class="text-xs text-gray-500 mt-1">Lo usaremos para abrir WhatsApp y confirmar la reserva.</p>
                    </div>

                    <button type="submit" id="confirm-button" class="w-full py-3 bg-primary text-gray-900 font-bold rounded-lg shadow-lg hover:bg-yellow-300 transition-colors">
                        Confirmar y Abrir WhatsApp
                    </button>
                </form>

                <!-- Modal / Message Box for Confirmation -->
                <div id="modal" class="hidden fixed inset-0 bg-black bg-opacity-75 z-50 flex items-center justify-center p-4" onclick="closeModal()">
                    <div class="bg-gray-800 p-6 rounded-xl shadow-2xl max-w-sm w-full" onclick="event.stopPropagation()">
                        <h3 id="modal-title" class="text-xl font-semibold mb-4 text-primary"></h3>
                        <p id="modal-message" class="text-gray-300 mb-6"></p>
                        <button class="w-full py-2 bg-primary text-gray-900 font-semibold rounded-lg" onclick="closeModal()">Cerrar</button>
                    </div>
                </div>

            </div>
        </aside>

    </main>

    <!-- Photo Gallery (Vestuarios, Canchas) - RUTAS ACTUALIZADAS -->
    <section class="mt-12">
        <h2 class="text-2xl font-semibold mb-4 text-primary">Instalaciones Big Spin</h2>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <img src="assets/cancha-techada.jpeg" alt="Cancha Techada" class="w-full h-40 object-cover rounded-lg shadow-lg transition-transform duration-300 hover:scale-[1.02]">
            <img src="assets/cancha-exterior.jpeg" alt="Cancha Exterior de Noche" class="w-full h-40 object-cover rounded-lg shadow-lg transition-transform duration-300 hover:scale-[1.02]">
            <img src="assets/vestuario.jpeg" alt="Vestuarios Modernos" class="w-full h-40 object-cover rounded-lg shadow-lg transition-transform duration-300 hover:scale-[1.02]">
            <img src="assets/area-descanso.jpeg" alt="Área de descanso y bar" class="w-full h-40 object-cover rounded-lg shadow-lg transition-transform duration-300 hover:scale-[1.02]">
        </div>
    </section>

    <script>
        // --- CONSTANTES Y CONFIGURACIÓN ---
        // Horario de apertura (10:00 AM) y cierre (23:00 PM - el último turno es a las 23:00 y termina a las 24:00)
        const OPEN_HOUR = 10;
        const CLOSE_HOUR = 23; // Último turno comienza a las 23:00
        const DAYS_TO_SHOW = 21; // 3 semanas
        const COURT_NAMES = {
            indoor: 'Cancha Techada',
            outdoor: 'Cancha al Aire Libre'
        };
        // Correo del administrador (no se usa directamente, solo para referencia)
        const ADMIN_EMAIL = "bigspinbond@gmail.com";
        // Número de WhatsApp del administrador (Reemplazar con el número real en producción)
        const ADMIN_WHATSAPP_NUMBER = "5491100000000"; // Ejemplo: 549 + código de área sin 0 + número sin 15

        // --- GOOGLE SHEETS CONFIGURACIÓN (Requiere Google Apps Script) ---
        // ID de la hoja de cálculo proporcionada:
        const SHEET_ID = '1nJMn9kyf_c4AFsmqD5cjjC4_-ggdWukV';
        
        // NOTA: Esta URL debe ser reemplazada por el 'URL de la aplicación web' que obtienes al
        // publicar un script de Google Apps vinculado a tu Google Sheet.
        // Mientras no lo publiques, la web usará datos de simulación.
        const GOOGLE_APP_SCRIPT_URL = 'https://script.google.com/macros/s/TU_WEB_APP_ID/exec'; // Placeholder de URL

        // --- ESTADO DE LA APLICACIÓN ---
        let currentCourt = 'indoor';
        let selectedSlot = null; // { date: 'YYYY-MM-DD', time: 'HH:MM', court: 'indoor'|'outdoor' }
        let allReservations = [];

        // --- FUNCIONES DE UTILIDAD ---

        /**
         * Muestra un modal de mensaje en lugar de alert().
         * @param {string} title Título del modal.
         * @param {string} message Mensaje a mostrar.
         */
        function showModal(title, message) {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').textContent = message;
            document.getElementById('modal').classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('modal').classList.add('hidden');
        }

        /**
         * Formatea una fecha como 'YYYY-MM-DD'.
         * @param {Date} date Objeto Date.
         * @returns {string} Fecha formateada.
         */
        const formatDate = (date) => date.toISOString().split('T')[0];

        /**
         * Formatea una fecha como 'Lunes 15 de Octubre'.
         * @param {Date} date Objeto Date.
         * @returns {string} Fecha legible.
         */
        const formatDayHeader = (date) => {
            return date.toLocaleDateString('es-AR', {
                weekday: 'long',
                day: 'numeric',
                month: 'long'
            });
        };

        // --- CONEXIÓN CON GOOGLE SHEETS (Vía Google Apps Script) ---

        /**
         * Carga las reservas desde Google Sheets (usando GAS como backend).
         * @returns {Promise<Array<{date: string, time: string, court: string, name: string}>>}
         */
        async function fetchReservationsFromGoogleSheets() {
            // Datos de simulación (se usan como fallback si el GAS no está configurado o falla)
            const mockData = [
                ['2025-12-11', '19:00', 'indoor', 'Carlos G.', '11...'], 
                ['2025-12-11', '21:00', 'outdoor', 'Daniel F.', '11...'],
                ['2025-12-12', '10:00', 'indoor', 'Ezequiel P.', '11...'],
                ['2025-12-15', '20:00', 'indoor', 'Fede R.', '11...'],
                ['2025-12-15', '21:00', 'outdoor', 'Gabi H.', '11...'],
                ['2025-12-25', '18:00', 'indoor', 'Hernán M.', '11...'],
            ];

            try {
                // Intento de conexión al Web App (GAS)
                // Se espera que el GAS devuelva un array de arrays con la estructura [Fecha, Hora, Cancha, Nombre, Teléfono]
                const response = await fetch(GOOGLE_APP_SCRIPT_URL + '?action=getReservations');
                if (!response.ok) throw new Error('Respuesta de red no OK o App Script no publicada/acceso denegado.');
                
                const dataFromSheet = await response.json();
                
                if (Array.isArray(dataFromSheet)) {
                    console.log("Datos cargados exitosamente desde la simulación del Web App.");
                    // Mapear los datos reales del Sheet: [Fecha, Hora, Cancha, ...]
                    return dataFromSheet.map(row => ({
                        date: row[0],
                        time: row[1],
                        court: row[2], // Asegúrate de que el Sheet use 'indoor' o 'outdoor'
                        name: row[3]
                    }));
                } else {
                    throw new Error('Formato de datos de Sheets inesperado. Usando mock data.');
                }
            } catch (error) {
                console.warn(`[ADVERTENCIA] No se pudo cargar la data de la URL de Apps Script. Usando datos de simulación. Error: ${error.message}`);
                 // Fallback a mock data
                 return mockData.map(row => ({
                    date: row[0],
                    time: row[1],
                    court: row[2],
                    name: row[3]
                }));
            }
        }

        /**
         * Envía una nueva reserva al Google Sheet (usando GAS como backend).
         * @param {object} reservationData Datos de la reserva.
         */
        async function sendReservationToGoogleSheets(reservationData) {
            // NOTA IMPORTANTE: Para que esto funcione, DEBES configurar un Google Apps Script (GAS)
            // en tu Google Sheet con una función doPost() que inserte los datos.

            try {
                const dataToSend = {
                    action: 'addReservation',
                    date: reservationData.date,
                    time: reservationData.time,
                    court: reservationData.court,
                    name: reservationData.name,
                    phone: reservationData.phone
                };
                
                const response = await fetch(GOOGLE_APP_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors', // Necesario para evitar problemas de CORS en Apps Script simple
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams(dataToSend),
                });
                
                // Con no-cors no podemos verificar response.ok ni leer el cuerpo.
                // Asumimos éxito si no hay error de red.
                console.log("SIMULACIÓN: Solicitud POST enviada a Google Apps Script para guardar reserva.");
                return true;

            } catch (error) {
                console.error("Error al enviar reserva al Web App (GAS):", error);
                showModal("Error de Conexión", "No se pudo enviar la reserva. Revisa la configuración de Google Apps Script.");
                return false;
            }
        }

        // --- LÓGICA DE INTERFAZ (Sin cambios en esta sección) ---

        /**
         * Genera y renderiza el calendario de 3 semanas.
         */
        async function renderCalendar() {
            // 1. Cargar datos de reservas
            try {
                allReservations = await fetchReservationsFromGoogleSheets();
            } catch (error) {
                console.error("Error al cargar reservas:", error);
                showModal("Error de Conexión", "No se pudieron cargar los horarios. Intenta recargar la página.");
                return;
            }

            const container = document.getElementById('calendar-container');
            container.innerHTML = '';
            let currentDate = new Date();
            currentDate.setHours(0, 0, 0, 0);

            // 2. Generar días
            for (let i = 0; i < DAYS_TO_SHOW; i++) {
                const dateString = formatDate(currentDate);
                const dayOfWeek = currentDate.getDay(); // 0=Domingo, 1=Lunes, ..., 6=Sábado
                const isSunday = dayOfWeek === 0;
                // El turno se cierra si ya pasó la hora actual del día
                const now = new Date();
                const isPast = (currentDate.getTime() < now.getTime() && dateString === formatDate(now)) || currentDate.getTime() < now.getTime();


                // Contenedor del Día
                const dayDiv = document.createElement('div');
                dayDiv.className = 'p-4 bg-gray-700 rounded-xl shadow-lg';

                // Título del Día
                const header = document.createElement('h3');
                header.className = 'text-xl font-bold mb-3 border-b pb-2 border-gray-600 capitalize';
                header.textContent = formatDayHeader(currentDate);
                dayDiv.appendChild(header);

                // Grid de Horarios
                const slotsGrid = document.createElement('div');
                slotsGrid.className = 'grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 lg:grid-cols-7 xl:grid-cols-9 gap-2';

                // 3. Generar franjas horarias
                for (let h = OPEN_HOUR; h <= CLOSE_HOUR; h++) {
                    const timeString = `${String(h).padStart(2, '0')}:00`;
                    const slotId = `${dateString}-${timeString}-${currentCourt}`;
                    const isReserved = allReservations.some(r =>
                        r.date === dateString &&
                        r.time === timeString &&
                        r.court === currentCourt
                    );

                    let statusClass = 'available';
                    let statusText = 'Reservar';

                    // Comprobar si la hora ya pasó (solo para el día actual)
                    const slotDateTime = new Date(dateString + 'T' + timeString + ':00');
                    const isTimePast = dateString === formatDate(now) && slotDateTime.getTime() < now.getTime();


                    if (isSunday || isTimePast) {
                        statusClass = 'closed';
                        statusText = isSunday ? 'Cerrado' : 'Pasado';
                    } else if (isReserved) {
                        statusClass = 'reserved';
                        statusText = 'Ocupado';
                    }

                    // Creación del Slot
                    const slotDiv = document.createElement('div');
                    slotDiv.id = slotId;
                    slotDiv.className = `hour-slot text-center py-2 rounded-lg font-semibold text-sm ${statusClass}`;
                    slotDiv.innerHTML = `<span class="block">${timeString}</span><span class="text-xs font-normal">${statusText}</span>`;

                    // Agregar Evento de Click
                    if (statusClass === 'available') {
                        slotDiv.addEventListener('click', () => handleSlotClick(dateString, timeString, currentCourt, slotDiv));
                    }

                    slotsGrid.appendChild(slotDiv);
                }

                dayDiv.appendChild(slotsGrid);
                container.appendChild(dayDiv);

                // Avanzar al siguiente día
                currentDate.setDate(currentDate.getDate() + 1);
            }
        }

        /**
         * Maneja el clic en un turno disponible.
         * @param {string} dateString Fecha 'YYYY-MM-DD'.
         * @param {string} timeString Hora 'HH:MM'.
         * @param {string} court Cancha.
         * @param {HTMLElement} clickedElement El elemento div clickeado.
         */
        function handleSlotClick(dateString, timeString, court, clickedElement) {
            // Deseleccionar el slot anterior (si existe)
            if (selectedSlot) {
                const prevSlotId = `${selectedSlot.date}-${selectedSlot.time}-${selectedSlot.court}`;
                const prevElement = document.getElementById(prevSlotId);
                if (prevElement) {
                    prevElement.classList.remove('selected-slot');
                }
            }

            // Si se hizo click en el mismo slot, deseleccionarlo y terminar
            if (selectedSlot && selectedSlot.date === dateString && selectedSlot.time === timeString && selectedSlot.court === court) {
                selectedSlot = null;
                document.getElementById('selected-reservation').classList.add('hidden');
                document.getElementById('reservation-form').classList.add('hidden');
                document.getElementById('no-selection-message').classList.remove('hidden');
            } else {
                // Seleccionar el nuevo slot
                selectedSlot = { date: dateString, time: timeString, court: court };

                // Resaltar el nuevo slot
                clickedElement.classList.add('selected-slot');

                // Actualizar el formulario lateral
                const selectedDate = new Date(dateString + 'T' + timeString);
                const formattedDateTime = selectedDate.toLocaleDateString('es-AR', {
                    weekday: 'long', day: 'numeric', month: 'long', hour: '2-digit', minute: '2-digit'
                }) + ' hs';

                document.getElementById('reserve-court').textContent = COURT_NAMES[court];
                document.getElementById('reserve-datetime').textContent = formattedDateTime.charAt(0).toUpperCase() + formattedDateTime.slice(1); // Capitalizar
                document.getElementById('selected-reservation').classList.remove('hidden');
                document.getElementById('reservation-form').classList.remove('hidden');
                document.getElementById('no-selection-message').classList.add('hidden');
            }
        }

        /**
         * Cambia la cancha activa y regenera el calendario.
         * @param {string} court 'indoor' o 'outdoor'.
         */
        function selectCourt(court) {
            currentCourt = court;
            selectedSlot = null; // Limpiar selección

            // Actualizar el estado visual de los botones
            const selector = document.getElementById('court-selector');
            Array.from(selector.children).forEach(btn => {
                if (btn.dataset.court === court) {
                    btn.classList.remove('text-gray-300', 'hover:bg-gray-700');
                    btn.classList.add('bg-primary', 'text-gray-900', 'shadow-lg');
                } else {
                    btn.classList.remove('bg-primary', 'text-gray-900', 'shadow-lg');
                    btn.classList.add('text-gray-300', 'hover:bg-gray-700');
                }
            });

            // Ocultar selección actual y formulario
            document.getElementById('selected-reservation').classList.add('hidden');
            document.getElementById('reservation-form').classList.add('hidden');
            document.getElementById('no-selection-message').classList.remove('hidden');

            // Renderizar el nuevo calendario
            renderCalendar();
        }

        /**
         * Maneja el envío del formulario de reserva.
         * @param {Event} e Evento de envío.
         */
        document.getElementById('reservation-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            if (!selectedSlot) {
                showModal("Error", "Por favor, selecciona un turno antes de confirmar.");
                return;
            }

            const name = document.getElementById('name').value.trim();
            const phone = document.getElementById('phone').value.trim();

            if (!name || !phone) {
                showModal("Faltan Datos", "Debes completar tu Nombre y Teléfono.");
                return;
            }

            // Datos para enviar/WhatsApp
            const reservationData = {
                date: selectedSlot.date,
                time: selectedSlot.time,
                court: selectedSlot.court,
                courtName: COURT_NAMES[selectedSlot.court],
                name: name,
                phone: phone,
                whatsappNumber: ADMIN_WHATSAPP_NUMBER
            };

            document.getElementById('confirm-button').textContent = "Procesando...";
            document.getElementById('confirm-button').disabled = true;

            try {
                // 1. SIMULACIÓN: Enviar datos al "Backend" para insertar en Google Sheets
                // Este paso intenta usar el GOOGLE_APP_SCRIPT_URL
                const success = await sendReservationToGoogleSheets(reservationData);

                if (success) {
                    // 2. Generar el mensaje de WhatsApp
                    const whatsappMessage = `¡Hola Big Spin! Quiero reservar un turno.\n\n` +
                        `*Detalles de la Reserva:*\n` +
                        `Cancha: ${reservationData.courtName}\n` +
                        `Fecha: ${new Date(reservationData.date).toLocaleDateString('es-AR', { day: 'numeric', month: 'long', year: 'numeric' })}\n` +
                        `Hora: ${reservationData.time} hs\n` +
                        `\n*Datos del Cliente:*\n` +
                        `Nombre: ${reservationData.name}\n` +
                        `Teléfono: ${reservationData.phone}\n` +
                        `\nPor favor, confírmenme la reserva. ¡Gracias!`;

                    const whatsappUrl = `https://wa.me/${reservationData.whatsappNumber}?text=${encodeURIComponent(whatsappMessage)}`;

                    // 3. Abrir WhatsApp
                    window.open(whatsappUrl, '_blank');

                    // 4. Mostrar mensaje de éxito y limpiar
                    showModal(
                        "Reserva Pendiente de Confirmación",
                        "Tu solicitud ha sido registrada y se abrirá WhatsApp para que la envíes a Big Spin. ¡Recuerda enviar el mensaje para que el turno sea confirmado!"
                    );

                    // 5. Resetear estado
                    selectedSlot = null;
                    document.getElementById('name').value = '';
                    document.getElementById('phone').value = '';
                    document.getElementById('selected-reservation').classList.add('hidden');
                    document.getElementById('reservation-form').classList.add('hidden');
                    document.getElementById('no-selection-message').classList.remove('hidden');

                    // 6. Volver a cargar el calendario (para que el slot aparezca como ocupado)
                    // NOTA: Si usas el GAS real, el nuevo turno aparecerá inmediatamente como ocupado.
                    renderCalendar();

                } else {
                    showModal("Error en el Servidor", "Hubo un problema al registrar la reserva. Intenta de nuevo.");
                }

            } catch (error) {
                console.error("Error en la reserva:", error);
                showModal("Error Crítico", "No se pudo completar el proceso de reserva. Revisa tu conexión.");
            } finally {
                document.getElementById('confirm-button').textContent = "Confirmar y Abrir WhatsApp";
                document.getElementById('confirm-button').disabled = false;
            }
        });

        // --- INICIALIZACIÓN ---
        window.onload = function() {
            // Mostrar la fecha y hora actual en la consola para referencia de la simulación
            console.log(`Punto de referencia: ${new Date().toLocaleString('es-AR')}`);
            // Iniciar la aplicación con la cancha techada
            selectCourt(currentCourt);
        };
    </script>
</body>
</html>
